import superagentPromise from"superagent-promise";import _superagent from"superagent";import{TextEncoder}from"text-encoding";import Utils from"./CAP/Utils/Utils";import AuthStore from"../Store/CapAuthStore";const superagent=superagentPromise(_superagent,global.Promise);var base64js=require("base64-js");function Base64Encode(a,b="utf-8"){var c=new TextEncoder(b).encode(a);return base64js.fromByteArray(c)}const handleErrors=(a,b)=>{let c="",d=null;return a&&(c=a.message,d=a.status,a.response.body&&a.response.body.message&&(c+=" \u0130stek Sonucu :"+a.response.body.message),a.response.error.message&&(c+=" Sistem Mesaj\u0131 :"+a.response.error.message)),b&&504===b.status&&(Utils.Alert({position:"tc",title:Utils.Translate("\u0130stek ger\xE7ekle\u015Ftirilemedi"),message:Utils.Translate(b.statusText),level:"error",autoDismiss:5}),-1!=b.error.url.indexOf("/securityService/")&&AuthStore.logout().then(()=>{window.location="/#/login"})),b&&200!=b.status&&(b&&401===b.status||a&&401==a.status)&&AuthStore.logout().then(()=>{window.location="/#/login"}),b&&404===b.status&&Utils.Alert({position:"tc",title:Utils.Translate("\u0130stek ger\xE7ekle\u015Ftirilemedi"),message:Utils.Translate(b.statusText),level:"error",autoDismiss:5}),null==d&&b&&500===b.status&&Utils.Alert({position:"tc",title:Utils.Translate("Hata olu\u015Ftu"),message:Utils.Translate("Gerekli moduller y\xFCklenemedi. L\xFCtfen tekrar deneyiniz. :errorText",{errorText:c}),level:"error",autoDismiss:5}),a&&Utils.Alert({position:"tc",title:Utils.Translate("Hata olu\u015Ftu"),message:Utils.Translate("\u0130\u015Flem s\u0131ras\u0131nda hata olu\u015Ftu. L\xFCtfen tekrar deneyiniz.:errorText",{errorText:c}),level:"error",autoDismiss:5}),b&&502===b.status&&Utils.Alert({position:"tc",title:Utils.Translate("Hata olu\u015Ftu"),message:Utils.Translate("Gerekli moduller y\xFCklenemedi. L\xFCtfen tekrar deneyiniz."),level:"error",autoDismiss:5}),b&&504===b.status&&Utils.Alert({position:"tc",title:Utils.Translate("Hata olu\u015Ftu"),message:Utils.Translate(b.statusText),level:"error"}),a},responseBody=a=>a.body,tokenPlugin=a=>{if(a.set("Access-Control-Allow-Origin","*"),window.localStorage.getItem("accessToken")){var b=Base64Encode(window.localStorage.getItem("accessToken")+":");a.set("Authorization",`Basic ${b}`)}},Request={timeout:3e4,deadline:6e4,del:a=>superagent.del(`${API_ROOT_URL}${a}`).use(tokenPlugin).on("error",handleErrors).end(handleErrors).then(responseBody),get:(a,b={})=>{var c=`${API_ROOT_URL}${a}`;return(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("//"))&&(c=a),superagent.get(`${c}`).query(b).use(tokenPlugin).end(handleErrors).then(responseBody)},put:(a,b)=>superagent.put(`${API_ROOT_URL}${a}`,b).use(tokenPlugin).on("error",handleErrors).end(handleErrors).then(responseBody),post:(a,b,c="post")=>"multipart"==c?Request.postMultiPart(a,b):"formdata"==c?Request.postForm(a,b):Request.postJson(a,b),postJson:(a,b)=>{var c=`${API_ROOT_URL}${a}`;return a.startsWith("http://")&&a.startsWith("https://")&&(c=a),superagent.post(c,b).use(tokenPlugin).on("error",handleErrors).end(handleErrors).then(responseBody)},postForm:(a,b)=>{var c=`${API_ROOT_URL}${a}`;return a.startsWith("http://")&&a.startsWith("https://")&&(c=a),superagent.post(c,b).type("form").use(tokenPlugin).on("error",handleErrors).end(handleErrors).then(responseBody)},postMultiPart:(a,b)=>{var c=superagent.post(`${API_ROOT_URL}${a}`);return Object.keys(b).forEach(function(a){b[a]instanceof File?(c.attach(a,b[a]),console.debug("Attach file",b[a])):c.field(a,b[a])}),c.retry(0),c.use(tokenPlugin),c.on("error",handleErrors),c.then(responseBody)}};export default Request;