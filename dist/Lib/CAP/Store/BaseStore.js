var _dec,_dec2,_class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_temp;function _initializerDefineProperty(a,b,c,d){c&&Object.defineProperty(a,b,{enumerable:c.enumerable,configurable:c.configurable,writable:c.writable,value:c.initializer?c.initializer.call(d):void 0})}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _applyDecoratedDescriptor(a,b,c,d,e){var f={};return Object.keys(d).forEach(function(a){f[a]=d[a]}),f.enumerable=!!f.enumerable,f.configurable=!!f.configurable,("value"in f||f.initializer)&&(f.writable=!0),f=c.slice().reverse().reduce(function(c,d){return d(a,b,c)||c},f),e&&void 0!==f.initializer&&(f.value=f.initializer?f.initializer.call(e):void 0,f.initializer=void 0),void 0===f.initializer&&(Object.defineProperty(a,b,f),f=null),f}function _initializerWarningHelper(){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and set to use loose mode. To use proposal-class-properties in spec mode with decorators, wait for the next major version of decorators in stage 2.")}import{action,observable,toJS,values}from"mobx";import Utils from"../Utils/Utils";import Validator from"../Utils/Validator";import DataProxy from"../Data/DataProxy";let BaseStore=(_dec=observable.struct,_dec2=observable.ref,_class=(_temp=function(){function a(){_classCallCheck(this,a),this._defaultConfig={baseParams:{page:0,size:50,dir:"id",desc:"asc"}},this._Request={},this.dataProxy=new DataProxy,_initializerDefineProperty(this,"_parameters",_descriptor,this),_initializerDefineProperty(this,"_model",_descriptor2,this),this.primaryKey="id",this._scenario="default",this._limit=20,this._baseUrl="",this._Action={get:"get",read:"read",save:"save",update:"update",delete:"delete"},_initializerDefineProperty(this,"_actionStatus",_descriptor3,this),this._Rules=[],_initializerDefineProperty(this,"Attributes",_descriptor4,this),this.cacheUrl=!1,_initializerDefineProperty(this,"_data",_descriptor5,this),_initializerDefineProperty(this,"totalCount",_descriptor6,this),_initializerDefineProperty(this,"currentPage",_descriptor7,this),this._validator=Validator,_initializerDefineProperty(this,"_ValidateErrors",_descriptor8,this),_initializerDefineProperty(this,"_isValid",_descriptor9,this),_initializerDefineProperty(this,"_ErrorText",_descriptor10,this),this._validator.showMessages(),this._Rules=this._Rules.map(function(a){return a.scenario||(a=Object.assign(a,{scenario:"default"})),a}),this.init()}return _createClass(a,[{key:"init",value:function init(){this.Request=this.dataProxy.createProxy("ajax")}},{key:"setScenario",value:function setScenario(a){this._scenario=a}},{key:"getAttr",value:function getAttr(a){return this.Attributes[a]||null}},{key:"setAttr",value:function setAttr(a,b){this.Attributes[a]=b}},{key:"addError",value:function addError(a){this.ValidateErrors=Object.assign(this.ValidateErrors,a)}},{key:"addRecord",value:function addRecord(a,b){this._data.set(a,b)}},{key:"removeRecord",value:function removeRecord(a){this._data.delete(a)}},{key:"abort",value:function abort(){this._Request.abort()}},{key:"reset",value:function reset(){return this.ErrorText="",this.ValidateErrors=[],this.isLoading=!1,this.page=0,this.totalCount=0,this.currentPage=0,this._data.clear(),this.parameters={page:0,size:50,dir:"id",desc:"asc"},this}},{key:"clear",value:function clear(){return this._data.clear(),this.ErrorText="",this.ValidateErrors=[],this.isLoading=!1,this.page=0,this.totalCount=0,this.currentPage=0,this.actionStatus.set("get",!1).set("read",!1).set("load",!1).set("save",!1).set("update",!1).set("delete",!1),this}},{key:"setDefaultSortDir",value:function setDefaultSortDir(a,b="ASC"){this._defaultConfig.baseParams.dir=a,this._defaultConfig.baseParams.sort=b}},{key:"setParameters",value:function setParameters(a={}){this._parameters=Object.assign(this.parameters,a)}},{key:"getActionStatus",value:function getActionStatus(a){this.actionStatus.get(a)}},{key:"setActionStatus",value:function setActionStatus(a,b){this.actionStatus.set(a,b)}},{key:"findById",value:function findById(a){return this._data.get(a)}},{key:"find",value:function find(a){return this._data.get(a)}},{key:"findByModel",value:function findByModel(a){return this._model.get(a)}},{key:"findByField",value:function findByField(a,b){let c=[];return this._data.forEach(d=>{d[a]==b&&c.push(d)}),c}},{key:"load",value:function load(a={}){this.clear(),this.setActionStatus("read",!0),this.setActionStatus("load",!0),Utils.isEmpty(a)||(a.filter&&(a.filter=JSON.stringify(a.filter)),this.setParameters(a));let b=this.baseUrl+this.Action.read+"?"+this.stringify(this.parameters);return this.cacheUrl||(b=b+"&rnd="+Math.random()),this._Request.get(b).then(action(a=>(a&&(a.data.forEach(a=>{this.addRecord(a[this.primaryKey],a)}),this.totalCount=a.totalCount),a))).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(action(()=>{this.setActionStatus("read",!1),this.setActionStatus("load",!1)}))}},{key:"get",value:function get(a,b=this.primaryKey){this.actionStatus.get=!0;let c=this.baseUrl+this.Action.get,d={};return!1==a||null==a||(Utils.isObject(b)?d=b:d[b]=a),this._Request.get(c,d).then(action(b=>(this._model.set(a,b),b))).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(action(()=>{this.actionStatus.get=!1}))}},{key:"save",value:function save(a,b=!0,c="json"){return this.actionStatus.save=!0,this._Request.post(this.baseUrl+this.Action.save,a,c).then(action(a=>a)).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(action(()=>{this.actionStatus.save=!0}))}},{key:"update",value:function update(a,b="json"){return this.actionStatus.update_=!0,this._Request.post(this.baseUrl+this.Action.update,a,b).then(action(a=>a)).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(action(()=>{this.actionStatus.update_=!1}))}},{key:"delete",value:function _delete(a,b="formdata"){return this.actionStatus.delete=!1,this._Request.post(this.baseUrl+this.Action.delete,a,b).then(action(a=>a)).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(action(()=>{this.actionStatus.delete=!0}))}},{key:"validate",value:function validate(a,b=this._scenario){return this.ValidateErrors=[],this._validator.errorMessages={},this.Rules.forEach(function(c){c.scenario==b?this._validator.message(c.name,void 0===a[c.name]?"":a[c.name],c.rule,{message:c.message}):"default"==c.scenario&&"default"==b&&(console.log(c,b),this._validator.message(c.name,void 0===a[c.name]?"":a[c.name],c.rule,{message:c.message}))}.bind(this)),this.ValidateErrors=this._validator.getErrorMessages(),this._isValid=this._validator.allValid(),this._isValid}},{key:"stringify",value:function stringify(a){return a?Object.keys(a).map(function(b){var c=a[b];return Array.isArray(c)?c.map(function(a){return encodeURIComponent(b)+"="+encodeURIComponent(a)}).join("&"):c instanceof Object?encodeURIComponent(b)+"="+JSON.stringify(c):encodeURIComponent(b)+"="+encodeURIComponent(c)}.bind(this)).join("&"):""}},{key:"Request",get:function(){return this._Request},set:function(a){this._Request=a}},{key:"scenario",get:function(){return this._scenario},set:function(a){this._scenario=a}},{key:"limit",get:function(){return this._limit},set:function(a){this._limit=a}},{key:"baseUrl",get:function(){return this._baseUrl},set:function(a){this._baseUrl=a}},{key:"Action",get:function(){return this._Action},set:function(a){this._Action=a}},{key:"Rules",get:function(){return this._Rules},set:function(a){this._Rules=a}},{key:"data",get:function(){return toJS(values(this._data))},set:function(a){this._data=a}},{key:"model",get:function(){return toJS(values(this._model))},set:function(a){this._model=a}},{key:"actionStatus",get:function(){return this._actionStatus},set:function(a){this._actionStatus=a}},{key:"validator",get:function(){return this._validator},set:function(a){this._validator=a}},{key:"ValidateErrors",get:function(){return toJS(this._ValidateErrors)},set:function(a){this._ValidateErrors=a}},{key:"isValid",get:function(){return this._isValid},set:function(a){this._isValid=a}},{key:"errors",get:function(){return this.ValidateErrors}},{key:"ErrorText",get:function(){return this._ErrorText},set:function(a){this._ErrorText=a}},{key:"defaultConfig",get:function(){return this._defaultConfig},set:function(a){this._defaultConfig=a}},{key:"parameters",get:function(){return toJS(this._parameters)},set:function(a){this._parameters=a}}]),a}(),_temp),_descriptor=_applyDecoratedDescriptor(_class.prototype,"_parameters",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.assign({},this._defaultConfig.baseParams)}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"_model",[_dec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Map}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"_actionStatus",[_dec2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Map().set("get",!1).set("read",!1).set("load",!1).set("save",!1).set("update",!1).set("delete",!1)}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"Attributes",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"_data",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Map}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,"totalCount",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,"currentPage",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_descriptor8=_applyDecoratedDescriptor(_class.prototype,"_ValidateErrors",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,"_isValid",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,"_ErrorText",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_applyDecoratedDescriptor(_class.prototype,"getAttr",[action],Object.getOwnPropertyDescriptor(_class.prototype,"getAttr"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"setAttr",[action],Object.getOwnPropertyDescriptor(_class.prototype,"setAttr"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"addRecord",[action],Object.getOwnPropertyDescriptor(_class.prototype,"addRecord"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"abort",[action],Object.getOwnPropertyDescriptor(_class.prototype,"abort"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"reset",[action],Object.getOwnPropertyDescriptor(_class.prototype,"reset"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"clear",[action],Object.getOwnPropertyDescriptor(_class.prototype,"clear"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"setParameters",[action],Object.getOwnPropertyDescriptor(_class.prototype,"setParameters"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"getActionStatus",[action],Object.getOwnPropertyDescriptor(_class.prototype,"getActionStatus"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"setActionStatus",[action],Object.getOwnPropertyDescriptor(_class.prototype,"setActionStatus"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"load",[action],Object.getOwnPropertyDescriptor(_class.prototype,"load"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"save",[action],Object.getOwnPropertyDescriptor(_class.prototype,"save"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"update",[action],Object.getOwnPropertyDescriptor(_class.prototype,"update"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"delete",[action],Object.getOwnPropertyDescriptor(_class.prototype,"delete"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"validate",[action],Object.getOwnPropertyDescriptor(_class.prototype,"validate"),_class.prototype),_class);export{BaseStore as default};