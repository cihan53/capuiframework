var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_temp;function _initializerDefineProperty(a,b,c,d){c&&Object.defineProperty(a,b,{enumerable:c.enumerable,configurable:c.configurable,writable:c.writable,value:c.initializer?c.initializer.call(d):void 0})}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _applyDecoratedDescriptor(a,b,c,d,e){var f={};return Object.keys(d).forEach(function(a){f[a]=d[a]}),f.enumerable=!!f.enumerable,f.configurable=!!f.configurable,("value"in f||f.initializer)&&(f.writable=!0),f=c.slice().reverse().reduce(function(c,d){return d(a,b,c)||c},f),e&&void 0!==f.initializer&&(f.value=f.initializer?f.initializer.call(e):void 0,f.initializer=void 0),void 0===f.initializer&&(Object.defineProperty(a,b,f),f=null),f}function _initializerWarningHelper(){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and set to use loose mode. To use proposal-class-properties in spec mode with decorators, wait for the next major version of decorators in stage 2.")}import{action,observable,toJS}from"mobx";import Ajax from"./Ajax";import Utils from"../Utils/Utils";import DataProxy from"./DataProxy";let ElasticSql=(_class=(_temp=function(){function a(){_classCallCheck(this,a),this._baseUrl="",this.currentId=0,this.running=null,this.Ajax=null,_initializerDefineProperty(this,"_select",_descriptor,this),_initializerDefineProperty(this,"_joins",_descriptor2,this),this._limit=50,this._from="",this._maps={},this._start=0,this._fetch=0,this._sqlText="",this._whereText="",this._mainTable=process.env.REACT_APP_DEFAULT_INDEX||"eventdata-prod",_initializerDefineProperty(this,"_where",_descriptor3,this),_initializerDefineProperty(this,"_orderBy",_descriptor4,this),this._groupBy=null,this._debug=!1,_initializerDefineProperty(this,"isRunning",_descriptor5,this),this.tokenPlugin=()=>{},this.handleErrors=()=>{},this.responseBody=a=>a.body,this.abort=()=>{Utils.isEmpty(this.Ajax.running)||this.Ajax.running.abort()},this.init=()=>{this.regenerateQuery()},this._type="elasticsql",this.dataProxy=new DataProxy,this.Ajax=this.dataProxy.createProxy("ajax"),this.init=this.init.bind(this)}return _createClass(a,[{key:"regenerateQuery",value:function regenerateQuery(){this._select=[],this._joins=[],this._from=[],this._limit=null,this._start=0,this._fetch=0,this._sqlText="",this._mainTable=process.env.REACT_APP_DEFAULT_INDEX||"eventdata-prod",this._where=null,this._orderBy=null,this._groupBy=null}},{key:"mainTable",value:function mainTable(a){return this._mainTable=a,this}},{key:"where",value:function where(a){return this._where=a,this}},{key:"addWhere",value:function addWhere(){return this}},{key:"select",value:function select(a=[]){return this.regenerateQuery(),this._select=a,this}},{key:"join",value:function join(a="",b="",c=[]){return this._joins.push({type:a,table:b,on:c}),this}},{key:"order",value:function order(a=[]){return this.order=a,this}},{key:"limits",value:function limits(a=null){return this._limit=a,this}},{key:"orderBy",value:function orderBy(a){return this._orderBy=a,this}},{key:"groupBy",value:function groupBy(a){return this._groupBy=a,this}},{key:"from",value:function from(a){return this._mainTable=a,this}},{key:"conditions",value:function conditions(a,b="and"){if(Utils.isArray(a))for(let c in a){let d=a[c];if(Utils.isString(d))this._whereText+=" "+b+" "+d;else{let a="=";if(d.type&&"subset"==d.type&&d.items&&CAP.Utils.isArray(d.items)){this._whereText+=" "+b+" ( 1=1  ",d.items.forEach(a=>{this.conditions(a,"or")}),this._whereText+=")";continue}d.operator&&(a=d.operator),this._whereText+="in"==a.trim()||"is"==a.trim()||"between"==a.trim()?" "+b+" "+d.column+" "+a+" "+d.value+" ":" "+b+" "+d.column+" "+a+"'"+d.value+"'"}}else Utils.isString(a)&&!CAP.Utils.isEmpty(a)&&(this._whereText+=" "+b+" "+a)}},{key:"build",value:function build(){if(this._sqlText="",this._whereText="",this._sqlText+="select "+this._select.join(", "),this._sqlText+=" from "+this._mainTable,this._joins.forEach(a=>{this._sqlText+=" "+a.type+" join "+a.table+" on "+a.on.join(" and ")}),""!=this._where&&(this.conditions(this._where),this._sqlText+=" where 1=1 "+this._whereText),this._groupBy){let a=" group by ";this._groupBy.forEach(b=>{a+=b+","}),a=a.substr(0,a.length-1),this._sqlText+=a}if(this._orderBy){Utils.isArray(this._orderBy)||(this._orderBy=[this._orderBy]);let a=" order by ";this._orderBy.forEach(b=>{a+=b.field+" "+b.dir+","}),a=a.substr(0,a.length-1),this._sqlText+=a}return this._limit&&(this._sqlText+=" limit "+this._limit.start+","+this._limit.limit),this._sqlText}},{key:"execute",value:function execute(a=null){let b=a||this.build();this.isRunning=!0;var c={parameters:Object.assign({dashboardType:"GenericElasticSearch"},{query:b})};if(Utils.isEmpty(b))return new Promise((a,b)=>{b(Utils.__t("Hatal\u0131 sorgu. Sorgu Bo\u015F olamaz"))});console.debug("Run Elastic SQL:",b);let d=this.Ajax.post(this._baseUrl,c);return d.then(action(a=>{if(a&&a.data.hasOwnProperty("error"))throw this.ErrorText=a.data.error.root_cause.map(a=>a.reason+" "),this.ErrorText;return a})).catch(action(a=>{throw this.ErrorText=a.response&&a.response.body&&a.response.body.errors,a})).finally(()=>{this.isRunning=!1})}},{key:"schema",value:function schema(){let a="show "+this.table+"/_doc/_mapping";return this.execute(a).then(a=>this._maps=a)}},{key:"show",value:function show(a=null){let b="show "+(null==a?this.table:a);return this.execute(b).then(a=>this._maps=a)}},{key:"Request",get:function(){return this._Request},set:function(a){this._Request=a}},{key:"baseUrl",get:function(){return this._baseUrl},set:function(a){this._baseUrl=a}},{key:"table",get:function(){return this._mainTable}},{key:"wheres",get:function(){return toJS(this._where)}},{key:"whereText",get:function(){return Utils.trimStart(this._whereText.trim(),"and")}}],[{key:"_uniqueIdGenerator",value:function _uniqueIdGenerator(){return++this.currentId}}]),a}(),_temp),_descriptor=_applyDecoratedDescriptor(_class.prototype,"_select",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"_joins",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"_where",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"_orderBy",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"isRunning",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_applyDecoratedDescriptor(_class.prototype,"execute",[action],Object.getOwnPropertyDescriptor(_class.prototype,"execute"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"schema",[action],Object.getOwnPropertyDescriptor(_class.prototype,"schema"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"show",[action],Object.getOwnPropertyDescriptor(_class.prototype,"show"),_class.prototype),_class);export{ElasticSql as default};